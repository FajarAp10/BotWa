
if (text.toLowerCase().startsWith('.brat')) {
    const userText = text.replace('.brat', '').trim();
    if (!userText) {
        await sock.sendMessage(from, {
            text: 'âŒ Contoh: *.brat kamu kemana*'
        }, { quoted: msg });
        return;
    }

    await sock.sendMessage(from, { react: { text: 'â³', key: msg.key } });

    const isBypass = isOwner(sender) || isVIP(sender, from);
    const now = Date.now();
    const aksesBrat = bratAksesSementara.get(sender);
    const isTemporaryActive = aksesBrat && now < aksesBrat;

    // VIP dan Owner bebas limit
if (!(isOwner(sender) || isVIP(sender, from) || isTemporaryActive)) {
    const record = bratLimit.get(sender);
    if (record) {
        if (now - record.time < BRAT_COOLDOWN) {
            if (record.count >= MAX_BRAT) {
                const sisa = Math.ceil((BRAT_COOLDOWN - (now - record.time)) / 60000);
                await sock.sendMessage(from, {
                   text: `ğŸš« *Limit Tercapai*\n\nKamu hanya bisa memakai *.brat* 3x per jam.\nâ³ Tunggu *${sisa} menit* lagi atau beli akses *.belibrat* 30 menit.\n\nğŸ’¡ *Tips:* Beli akses *VIP* agar bisa memakai *.brat* tanpa batas waktu.`,

                    mentions: [sender]
                }, { quoted: msg });
                return;
            } else record.count++;
        } else {
            bratLimit.set(sender, { count: 1, time: now });
        }
    } else {
        bratLimit.set(sender, { count: 1, time: now });
    }
}


    try {
        const width = 512;
        const height = 512;
        const maxLineWidth = 470;
        let fontSize = 130;

        const words = userText.split(/\s+/);
        const estimateWordWidth = (word, size) => word.length * size * 0.6;

        function generateLines(size) {
            const result = [[]];
            let currentLineWidth = 0;
            for (let word of words) {
                const wordWidth = estimateWordWidth(word, size);
                if (currentLineWidth + wordWidth > maxLineWidth && result[result.length - 1].length > 0) {
                    result.push([word]);
                    currentLineWidth = wordWidth;
                } else {
                    result[result.length - 1].push(word);
                    currentLineWidth += wordWidth + 25 + Math.random() * 15;
                }
            }
            return result;
        }

        function isOverflow(lines, size) {
            const lineHeight = size + 20;
            if (lines.length * lineHeight > 480) return true;
            for (const line of lines) {
                let lineWidth = 0;
                for (const word of line) {
                    lineWidth += estimateWordWidth(word, size) + 25 + Math.random() * 15;
                }
                if (lineWidth > maxLineWidth) return true;
            }
            return false;
        }

        let lines = [];
        let tryFont = fontSize;

        while (tryFont >= 60) {
            const candidateLines = generateLines(tryFont);
            if (!isOverflow(candidateLines, tryFont)) {
                lines = candidateLines;
                fontSize = tryFont;
                break;
            }
            if (candidateLines.length <= 2 && words.length >= 6) tryFont -= 2;
            else tryFont -= 4;
        }

        if (lines.length === 0) {
            fontSize = 60;
            lines = generateLines(fontSize);
        }

        const lineHeight = fontSize + 20;
        const totalHeight = lines.length * lineHeight;
        const verticalBias = Math.floor((height - totalHeight) / 2 + fontSize * 0.40 + lines.length * 5);
        let y = verticalBias + 8; // buffer biar huruf gak nempel atas

        let svgText = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
  <rect width="100%" height="100%" fill="white"/>
  <style>
  .brat {
    font-family: 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', Arial, Helvetica, sans-serif;
    fill: black;
    font-size: ${fontSize}px;
  }
</style>\n`;

        for (const line of lines) {
            let x = 30;
            for (let word of line) {
                const yOffset = y + Math.floor(Math.random() * 6 - 3);
                svgText += `<text x="${x}" y="${yOffset}" class="brat">${word}</text>\n`;
                const wordWidth = estimateWordWidth(word, fontSize);
                x += wordWidth + 25 + Math.random() * 10;
            }
            y += lineHeight + Math.floor(Math.random() * 10);
        }

        svgText += `</svg>`;

        const buffer = await sharp({
            create: {
                width,
                height,
                channels: 4,
                background: 'white'
            }
        })
        .composite([{ input: Buffer.from(svgText), top: 0, left: 0 }])
        .webp()
        .toBuffer();

        const sticker = new Sticker(buffer, {
            type: 'FULL',
            pack: 'brat-anomali',
            author: 'Jarr',
            quality: 100
        });

        await sock.sendMessage(from, await sticker.toMessage(), { quoted: msg });
        await sock.sendMessage(from, { react: { text: 'âœ…', key: msg.key } });

    } catch (err) {
        console.error(err);
        await sock.sendMessage(from, {
            text: 'âŒ Gagal membuat stiker brat.'
        }, { quoted: msg });
    }
}





// ğŸ“Œ FITUR JADWAL PIKET
if (text.startsWith('.jadwalpiket')) {
    const allowedGroup = "120363421418985666@g.us";

    if (msg.key.remoteJid !== allowedGroup) {
        await sock.sendMessage(from, { text: 'âš ï¸ Fitur ini hanya bisa dipakai di *grup pg*!' });
        return;
    }

    const args = text.split(' ');
    const hari = (args[1] || '').toLowerCase();

    const jadwal = {
        senin: [
            "Aditya Rizky Arvano",
            "Bara Obama",
            "Herlina Ayu Putri",
            "Marsya Ayu Maharani",
            "Sarah Alicia",
            "Agusta Daffa Fahirawan",
            "Widya Ayu Khoirunnisa"
        ],
        selasa: [
            "Arum Khairun Nisa",
            "Dea Sekar Ningrum",
            "Leonita Syafrida",
            "Pradipta Sigma",
            "Rizky Satriaji Pamungkas",
            "Destra Dinata",
            "Viola Eka Putri Handoko"
        ],
        rabu: [
            "Arsya Zazillia Haryani",
            "Dhanis Ardhi Virmansyah",
            "Nabila Luthfiana Zulfa",
            "Rizky Aditya",
            "Saskia Diva Aprilia",
            "Fajar Keren bjir",
            "Azzahra Cahyani Putri P"
        ],
        kamis: [
            "Azisa Verga Riyani",
            "Firsa Puspita Kusuma",
            "Muhammad Baihaqi Arafah",
            "Muhammad Arif Murtadho",
            "Noor Allea Ellysa",
            "Syesil Carisa Inayah",
            "Muhammad Febra Adisandi W"
        ],
        jumat: [
            "Aulya Cinta Kinasih",
            "Galih Cahya Saputra",
            "Muhammad Zainus Sholikin",
            "Wahyu Januar Alatif",
            "Ribkhi Amelia Putri",
            "Zaskya Hening Nayla Nova",
            "Nadya Rizkayna Ramadhani"
        ],
        sabtu: [
            "Wayah e prei"
        ],
        minggu: [
            "Wayah e turu"
        ]
    };

    if (!hari || !jadwal[hari]) {
        await sock.sendMessage(from, { text: "âš ï¸ Gunakan: `.jadwalpiket <hari>`\nContoh: `.jadwalpiket senin`" });
        return;
    }

    const daftar = jadwal[hari].map(n => `ğŸ‘¤ ${n}`).join('\n');
    const hasil = `ğŸ“… *Jadwal Piket Hari ${hari.charAt(0).toUpperCase() + hari.slice(1)}*\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n${daftar}`;

    await sock.sendMessage(from, { text: hasil });
}

// ğŸ“Œ FITUR JADWAL MAPEL
if (text.startsWith('.jadwalmapel')) {
    const allowedGroup = "120363421418985666@g.us";

    if (msg.key.remoteJid !== allowedGroup) {
        await sock.sendMessage(from, { text: 'âš ï¸ Fitur ini hanya bisa dipakai di *grup PG*!' });
        return;
    }

    const args = text.split(' ');
    const hari = (args[1] || '').toLowerCase();

    const mapel = {
        senin: [
            "Kejuruan (Pak Anaf)",
            "Kejuruan (Bu Aji)"
        ],
        selasa: [
            "Kejuruan (Pak Adi)",
            "Kejuruan (Bu Ana)"
        ],
        rabu: [
            "PKK (Bu Minuk)",
            "MTK (Bu Inda)",
            "Kejuruan (Bu Ana - Jamkos)",
            "Agama (Bu Salis)"
        ],
        kamis: [
            "Sejarah (Bu Yukha)",
            "Olahraga (Pak Joko)",
            "Bahasa Indonesia (Bu Rimba)",
            "MTK (Bu Inda)",
            "Bahasa Jawa (Bu Elisa)"
        ],
        jumat: [
            "Bahasa Inggris (Bu Sarti)",
            "Agama (Bu Salis)",
            "PKN (Pak Sophan)",
            "Bahasa Inggris (Bu Sarti)"
        ]
    };

    if (!hari || !mapel[hari]) {
        await sock.sendMessage(from, { text: "âš ï¸ Gunakan: `.jadwalmapel <hari>`\nContoh: `.jadwalmapel rabu`" });
        return;
    }

    const daftar = mapel[hari].map((m, i) => `${i + 1}ï¸âƒ£ ${m}`).join('\n');
    const hasil = `ğŸ“š *Jadwal Mapel Hari ${hari.charAt(0).toUpperCase() + hari.slice(1)}*\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n${daftar}`;

    await sock.sendMessage(from, { text: hasil });
}

// ğŸ“Œ FITUR SPIN
if (text.startsWith('.spin')) {
    const groupIdKelas = "120363421418985666@g.us";

    // hanya untuk grup kelas
    if (msg.key.remoteJid !== groupIdKelas) {
        await sock.sendMessage(from, { text: "âš ï¸ Fitur ini hanya bisa dipakai di *grup PG*!" });
        return;
    }

    // gabungan semua nama
    const semuaNama = [
     
        "Aditya Rizky Arvano", "Bara Obama", "Herlina Ayu Putri",
        "Marsya Ayu Maharani", "Sarah Alicia", "Agusta Daffa Fahirawan",
        "Widya Ayu Khoirunnisa",

        "Arum Khairun Nisa", "Dea Sekar Ningrum", "Leonita Syafrida",
        "Pradipta Sigma", "Rizky Satriaji Pamungkas", "Destra Dinata",
        "Viola Eka Putri Handoko",

        "Arsya Zazillia Haryani", "Dhanis Ardhi Virmansyah",
        "Nabila Luthfiana Zulfa", "Rizky Aditya", "Saskia Diva Aprilia",
        "Fajar Keren bjir", "Azzahra Cahyani Putri P",

        "Azisa Verga Riyani", "Firsa Puspita Kusuma",
        "Muhammad Baihaqi Arafah", "Muhammad Arif Murtadho",
        "Noor Allea Ellysa", "Syesil Carisa Inayah",
        "Muhammad Febra Adisandi W",

        "Aulya Cinta Kinasih", "Galih Cahya Saputra",
        "Muhammad Zainus Sholikin", "Wahyu Januar Alatif",
        "Ribkhi Amelia Putri", "Zaskya Hening Nayla Nova",
        "Nadya Rizkayna Ramadhani"
    ];

    // cek jumlah spin
    const args = text.split(' ');
    let jumlah = parseInt(args[1]) || 1;
    if (jumlah < 1) jumlah = 1;
    if (jumlah > semuaNama.length) jumlah = semuaNama.length;

    // acak nama
    const copyNama = [...semuaNama];
    const hasil = [];
    for (let i = 0; i < jumlah; i++) {
        const index = Math.floor(Math.random() * copyNama.length);
        hasil.push(copyNama[index]);
        copyNama.splice(index, 1); // hapus biar gak dobel
    }

    // format hasil
    const teksHasil = hasil.map((n, i) => `*${i + 1}.* ğŸ‘¤ ${n}`).join('\n');
    const pesan = `ğŸ² *Spin Result!*\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n${teksHasil}`;

    await sock.sendMessage(from, { text: pesan });
}



function normalize(teks) {
    return teks
        .toLowerCase()
        .replace(/[^a-z0-9\s]/g, '')
        .replace(/\s+/g, ' ')
        .trim();
}

function cocokMirip(jawabanAsli, jawabanUser) {
    const a = normalize(jawabanAsli);
    const u = normalize(jawabanUser);

    // 1ï¸âƒ£ substring langsung
    if (a.includes(u) || u.includes(a)) return true;

    const kataAsli = a.split(' ');
    const kataUser = u.split(' ');

    let cocok = 0;

    for (const ku of kataUser) {
        for (const ka of kataAsli) {
            if (ka.includes(ku) || ku.includes(ka)) {
                cocok++;
                break;
            }
        }
    }

    // 2ï¸âƒ£ minimal 60% kata user nyambung
    return cocok / kataUser.length >= 0.6;
}

// ================= FAMILY 100 =================
if (text === '.family100') {
    if (sesiFamily100.has(from)) {
        await sock.sendMessage(from, {
            text: `âš ï¸ *Permainan Sedang Berlangsung!*
â”â”â”â”â”â”â”â”â”
Selesaikan dulu game sebelumnya.`
        });
        return;
    }

    const soal = ambilSoalAcak('family100', soalFamily100);

    const sent = await sock.sendMessage(from, {
        text: `ğŸ® *Family 100 Dimulai!*
â”â”â”â”â”â”â”â”â”
ğŸ§  *Pertanyaan:*
${soal.pertanyaan}

ğŸ“‹ *Jawaban:*
${soal.jawaban.map((_, i) => `*${i + 1}.*`).join('\n')}

â³ *Waktu:* 60 detik
â†©ï¸ *Balas pesan ini untuk menjawab.*`
    });

    const timeout = setTimeout(async () => {
        const sesi = sesiFamily100.get(from);
        if (!sesi) return;

        const dataSoal = soalFamily100.find(s => s.pertanyaan === sesi.pertanyaan);

        // â¬‡ï¸ TAMPILKAN PENJAWAB HANYA DI AKHIR
        const jawabanAkhir = dataSoal.jawaban.map((j, i) => {
            const user = sesi.penjawab[i];
            return user
                ? `*${i + 1}.* âœ… ${j} â€” @${user.split('@')[0]}`
                : `*${i + 1}.* âŒ ${j}`;
        }).join('\n');

        await sock.sendMessage(from, {
            text: `ğŸ‰ *Family 100 Selesai!*
â”â”â”â”â”â”â”â”â”
ğŸ§  *Pertanyaan:*
${sesi.pertanyaan}

ğŸ“‹ *Jawaban Lengkap:*
${jawabanAkhir}

ğŸŠ Terima kasih telah bermain!`,
            mentions: sesi.penjawab.filter(Boolean)
        });

        sesiFamily100.delete(from);
    }, 60000);

    sesiFamily100.set(from, {
        pesanId: sent.key.id,
        pertanyaan: soal.pertanyaan,
        jawaban: Array(soal.jawaban.length).fill(null),
        penjawab: Array(soal.jawaban.length).fill(null),
        timeout
    });

    return;
}

// ================= JAWAB =================
if (msg.message?.extendedTextMessage?.contextInfo?.stanzaId) {
    const sesi = sesiFamily100.get(from);
    if (!sesi) return;

    const replyId = msg.message.extendedTextMessage.contextInfo.stanzaId;
    if (replyId !== sesi.pesanId) return;

    const userJawab = text.trim().toLowerCase();
    const sender = msg.key.participant || msg.key.remoteJid;

    const dataSoal = soalFamily100.find(s => s.pertanyaan === sesi.pertanyaan);
    const index = dataSoal.jawaban.findIndex(
    j => cocokMirip(j, userJawab)
);


    // â¬‡ï¸ SAAT GAME BERJALAN (TANPA NAMA PENJAWAB)
    const renderSaatMain = () =>
        sesi.jawaban.map((j, i) =>
            j ? `*${i + 1}.* âœ… ${j}` : `*${i + 1}.*`
        ).join('\n');

    // âœ… BENAR
    if (index !== -1 && !sesi.jawaban[index]) {
        sesi.jawaban[index] = dataSoal.jawaban[index];
        sesi.penjawab[index] = sender;

        tambahSkor(sender, from, 20);

        const sentUpdate = await sock.sendMessage(from, {
    text: `ğŸ® *Jawaban Diterima!*
â”â”â”â”â”â”â”â”â”
ğŸ§  *Pertanyaan:*
${sesi.pertanyaan}

ğŸ“‹ *Jawaban Saat Ini:*
${renderSaatMain()}

ğŸ +20 poin untuk @${sender.split('@')[0]}
â†©ï¸ Balas pesan ini untuk menjawab.`,
    mentions: [sender] // ğŸ”¥ TAG AMAN DI SINI
});


        sesi.pesanId = sentUpdate.key.id;

        // ğŸ”¥ SEMUA TERJAWAB â†’ LANGSUNG SELESAI
        if (sesi.jawaban.every(j => j !== null)) {
            clearTimeout(sesi.timeout);
            sesiFamily100.delete(from);

            const jawabanAkhir = dataSoal.jawaban.map((j, i) => {
                const user = sesi.penjawab[i];
                return user
                    ? `*${i + 1}.* âœ… ${j} â€” @${user.split('@')[0]}`
                    : `*${i + 1}.* âŒ ${j}`;
            }).join('\n');

            await sock.sendMessage(from, {
                text: `ğŸ‰ *Family 100 Selesai!*
â”â”â”â”â”â”â”â”â”
ğŸ§  *Pertanyaan:*
${sesi.pertanyaan}

ğŸ“‹ *Jawaban Lengkap:*
${jawabanAkhir}

ğŸŠ Terima kasih telah bermain!`,
                mentions: sesi.penjawab.filter(Boolean)
            });
        }
        return;
    }

    // âŒ SALAH
    const sentSalah = await sock.sendMessage(from, {
        text: `ğŸš« *Jawaban Salah!*
â”â”â”â”â”â”â”â”â”
ğŸ§  *Pertanyaan:*
${sesi.pertanyaan}

ğŸ“‹ *Jawaban Saat Ini:*
${renderSaatMain()}

âŒ *"${userJawab}" tidak ada.*
â†©ï¸ Balas pesan ini untuk menjawab.`
    });

    sesi.pesanId = sentSalah.key.id;
}

